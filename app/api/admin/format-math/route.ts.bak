import { NextResponse } from 'next/server'
import { getSession } from '@/lib/admin-auth'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || 'dummy_key_for_build',
})

const MATH_FORMAT_PROMPT = `YOU ARE A TEXT FORMATTER. NOT A PROBLEM SOLVER. NOT A MATH TUTOR. ONLY A FORMATTER.

YOUR ONLY JOB: Take the exact text given to you and add proper Markdown/LaTeX formatting. NOTHING ELSE.

CRITICAL - READ THIS CAREFULLY:
- DO NOT SOLVE ANY PROBLEMS - If you see a question, DO NOT ANSWER IT
- DO NOT ADD ANY NEW CONTENT - Only format what's already there
- DO NOT EXPLAIN ANYTHING - No "To solve this", no "The task is to", no "We want to find"
- DO NOT EXPAND THE TEXT - Keep it the exact same length or shorter
- ONLY ADD FORMATTING - Just wrap math expressions with $ or $$

IF THE INPUT IS A QUESTION, OUTPUT THE SAME QUESTION WITH PROPER FORMATTING.
IF THE INPUT IS A STATEMENT, OUTPUT THE SAME STATEMENT WITH PROPER FORMATTING.
DO NOT TURN QUESTIONS INTO SOLUTIONS.
DO NOT ADD ANY WORDS THAT WEREN'T IN THE ORIGINAL TEXT.

FORMATTING RULES:
- Inline math → wrap with $...$.
- Block equations → wrap with $$...$$ on their own lines.
- CRITICAL: Currency (dollar amounts) → replace $ symbol with the word "dollar" or "dollars"
  - Example: "$1 chips" becomes "1 dollar chips"
  - Example: "$10 chips" becomes "10 dollar chips"
  - Example: "($1)" becomes "(1 dollar)"
  - Example: "$100 payout" becomes "100 dollar payout"
  - This prevents LaTeX parsing issues with the $ symbol
- Do NOT use any LaTeX environments: \\begin{itemize}, \\begin{enumerate}, \\begin{align}, tables, arrays, or any similar structure.
- Do NOT use bold, italics, or styling commands such as \\textbf{}, \\emph{}, etc.
- Bullet points are allowed, but only as plain text markdown using -.
- When listing multiple bullet points, each bullet must end with \\n explicitly.

Examples:

INPUT: "Find the probability of an even amount of heads when n coins are flipped."
WRONG OUTPUT: "To solve this, consider the following... The task is to calculate P(X is even)."
CORRECT OUTPUT: "Find the probability of an even amount of heads when $n$ coins are flipped."

INPUT: "One coin is fair, while the other n-1 have probability 0<λ<1"
CORRECT OUTPUT: "One coin is fair, while the other $n-1$ have probability $0<\\lambda<1$"

- Math formatting: $U$, $x^2$, $$\\int_0^1 x \\, dx$$
- Currency: Replace "dollar 1" with "1 dollar", "dollar 10" with "10 dollar"
- Bullet points must end with \\n

REMEMBER:
- You are ONLY a formatter, NOT a solver
- If the input is 50 words, your output should be roughly 50 words (just with $ symbols added)
- If the input is a question, keep it as a question
- Do not add phrases like "To solve this", "Consider", "The task is", "We want to", etc.

REPEAT: YOUR JOB IS TO FORMAT, NOT TO SOLVE OR EXPLAIN.`

export async function POST(request: Request) {
  const session = await getSession()

  if (!session) {
    return NextResponse.json(
      { error: 'Unauthorized' },
      { status: 401 }
    )
  }

  try {
    const { text } = await request.json()

    if (!text || typeof text !== 'string') {
      return NextResponse.json(
        { error: 'Text content is required' },
        { status: 400 }
      )
    }

    // Call OpenAI to format the text
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: MATH_FORMAT_PROMPT },
        { role: 'user', content: text },
      ],
      temperature: 0.3, // Lower temperature for consistent formatting
    })

    const formattedText = completion.choices[0].message.content

    if (!formattedText) {
      return NextResponse.json(
        { error: 'Empty response from OpenAI' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      success: true,
      formattedText
    })

  } catch (error) {
    console.error('Error formatting text:', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to format text' },
      { status: 500 }
    )
  }
}
